<!DOCTYPE html>
<html lang="si">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kegalle Scout Shop Online Store</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --maroon: #800000;
      --black: #000000;
      --white: #ffffff;
      --gray-light: #f4f4f4;
      --gray-medium: #ccc;
      --gray-dark: #333;
      --button-hover: #a04040;
    }

    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--gray-light);
      color: var(--gray-dark);
    }

    header {
      background-color: var(--maroon);
      color: var(--white);
      padding: 15px 20px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.8em;
    }

    #cart-summary {
      font-size: 1.1em;
      cursor: pointer;
      position: relative;
      padding: 5px 10px;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }

    #cart-summary:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    #cart-count {
      background-color: var(--black);
      color: var(--white);
      border-radius: 50%;
      padding: 3px 8px;
      font-size: 0.8em;
      position: absolute;
      top: -5px;
      right: -5px;
    }

    #loading, #error-display {
      text-align: center;
      padding: 20px;
      font-size: 1.2em;
      color: var(--maroon);
    }

    #error-display {
      color: red;
      font-weight: bold;
    }

    #product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px;
      padding: 25px;
      justify-items: center;
    }

    .product-card {
      background-color: var(--white);
      border: 1px solid var(--gray-medium);
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
    }

    .product-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-bottom: 1px solid var(--gray-medium);
    }

    .product-info {
      padding: 15px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .product-info h3 {
      margin: 0 0 10px;
      font-size: 1.4em;
      color: var(--maroon);
    }

    .product-info p {
      margin: 5px 0;
      font-size: 0.95em;
    }

    .product-info strong {
      color: var(--black);
    }

    .product-status {
      font-weight: bold;
      margin-top: 10px;
    }

    .status-in-stock {
      color: green;
    }

    .status-out-of-stock {
      color: var(--maroon);
    }

    .product-actions {
      padding: 15px;
      text-align: center;
      border-top: 1px solid var(--gray-light);
    }

    .add-to-cart-btn, .pre-order-btn {
      background-color: var(--maroon);
      color: var(--white);
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      transition: background-color 0.3s ease;
      width: 100%;
      box-sizing: border-box;
    }

    .add-to-cart-btn:hover, .pre-order-btn:hover {
      background-color: var(--button-hover);
    }

    .pre-order-btn {
      background-color: var(--black);
    }

    .pre-order-btn:hover {
      background-color: var(--gray-dark);
    }

    /* Cart Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: var(--white);
      margin: auto;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      position: relative;
    }

    .close-button {
      color: var(--gray-dark);
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close-button:hover,
    .close-button:focus {
      color: var(--black);
      text-decoration: none;
    }

    #cart-items {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--gray-light);
      padding-bottom: 10px;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px dashed var(--gray-light);
    }

    .cart-item:last-child {
      border-bottom: none;
    }

    .cart-item-info {
      flex-grow: 1;
    }

    .cart-item-info h4 {
      margin: 0 0 5px;
      font-size: 1.1em;
      color: var(--maroon);
    }

    .item-quantity-controls {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .item-quantity-controls button {
      background-color: var(--gray-medium);
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 1em;
    }

    .item-quantity-controls button:hover {
      background-color: var(--gray-dark);
      color: var(--white);
    }

    .remove-from-cart-btn {
      background-color: #dc3545;
      color: var(--white);
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      margin-left: 10px;
    }

    .remove-from-cart-btn:hover {
      background-color: #c82333;
    }

    #cart-total {
      text-align: right;
      font-size: 1.3em;
      font-weight: bold;
      margin-top: 15px;
      color: var(--black);
    }

    #order-whatsapp-btn {
      background-color: #25D366;
      color: var(--white);
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1em;
      width: 100%;
      margin-top: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: background-color 0.3s ease;
    }

    #order-whatsapp-btn:hover {
      background-color: #1DA851;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        gap: 10px;
      }
      header h1 {
        font-size: 1.5em;
      }
      #product-grid {
        padding: 15px;
        gap: 20px;
      }
      .product-card {
        max-width: 100%;
      }
      .modal-content {
        width: 95%;
        padding: 20px;
      }
    }

    @media (max-width: 480px) {
      .product-info h3 {
        font-size: 1.2em;
      }
      .add-to-cart-btn, .pre-order-btn, #order-whatsapp-btn {
        font-size: 0.95em;
        padding: 10px 12px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Kegalle Scout Shop Online Store</h1>
    <div id="cart-summary">
      ðŸ›’ Cart (<span id="cart-count">0</span>)
    </div>
  </header>

  <div id="loading">Loading products...</div>
  <div id="error-display" style="display:none;"></div>
  <div id="product-grid"></div>

  <div id="cartModal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>Your Cart</h2>
      <div id="cart-items">
        </div>
      <div id="cart-total">Total: Rs. 0.00</div>
      <button id="order-whatsapp-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-whatsapp"><path d="M23 10.45s-1.88-2.22-3.8-3.92c-1.92-1.7-4.1-2.92-6.4-3.62C9.55 2.1 7.18 2 4.8 2H2v2.8c1.37.52 2.62 1.3 3.75 2.37.95.88 1.77 1.87 2.45 2.9C9.5 9.8 9.9 10.8 10 11.8c-.13 1.1-.55 2.15-1.2 3.12-.55.85-1.18 1.6-1.9 2.25-.7.65-1.4 1.15-2.1 1.5-.7.35-1.35.55-1.95.65v2c.8-.1 1.6-.35 2.35-.75.75-.4 1.45-.9 2.1-1.5.65-.6 1.2-1.3 1.65-2.1.45-.8.75-1.65.9-2.55.15-.9.1-1.8-.15-2.7C10.75 8.9 9.8 7.35 8.5 6.1c-1.3-1.2-2.8-2-4.5-2.4V2h2.8c2.38 0 4.75.1 7.05.7 2.3.6 4.38 1.75 6.2 3.4 1.83 1.6 3.1 3.5 3.8 5.6.7 2.1.8 4.3.4 6.5-.4 2.2-1.3 4.2-2.7 5.9-1.4 1.7-3.1 3-5 3.9-1.9.9-3.9 1.3-5.9 1.3-2 0-4-.25-5.9-.75s-3.7-1.3-5.3-2.3C2 21.65 0 20.35 0 18.7c0-1.7 2-3.1 4-3.1s3.8.9 5.3 2.1c1.5 1.2 2.3 2.6 2.3 4.2s-.8 2.6-2.3 2.6c-1.5 0-3.3-.9-5.3-2.7L2 22.8V26h2.8c2.38 0 4.75-.1 7.05-.7 2.3-.6 4.38-1.75 6.2-3.4 1.83-1.6 3.1-3.5 3.8-5.6.7-2.1.8-4.3.4-6.5-.4-2.2-1.3-4.2-2.7-5.9-1.4-1.7-3.1-3-5-3.9-1.9-.9-3.9-1.3-5.9-1.3z"/></svg>
        Order on WhatsApp
      </button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const googleSheetCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQws-dLb68ZTjwNhkZU5vYBtsdM80KAqr0BkWQyq56yJsSM6ze540fseOcYSgWuPimLfJ6fX2J0GGFs/pub?gid=1261177907&single=true&output=csv';
      const whatsappNumber = '94713892108'; // Sri Lankan number format (94 is country code)
      const productGrid = document.getElementById('product-grid');
      const loadingIndicator = document.getElementById('loading');
      const errorDisplay = document.getElementById('error-display');
      const cartCountSpan = document.getElementById('cart-count');
      const cartModal = document.getElementById('cartModal');
      const closeButton = document.querySelector('.close-button');
      const cartSummary = document.getElementById('cart-summary');
      const cartItemsContainer = document.getElementById('cart-items');
      const cartTotalSpan = document.getElementById('cart-total');
      const orderWhatsappBtn = document.getElementById('order-whatsapp-btn');

      let cart = JSON.parse(localStorage.getItem('kegalleScoutCart')) || {};
      let allProducts = []; // To store all fetched products

      // --- CSV Parsing Functions ---
      function parseCsvRow(row) {
        const regex = /(".*?"|[^",]+)(?=\s*,|\s*$)/g;
        let values = row.match(regex) || [];
        return values.map(value => value.replace(/^"|"$/g, '').trim());
      }

      function parseCSV(csvText) {
        const lines = csvText.trim().split(/\r?\n/);
        if (lines.length < 2) return [];

        const headers = parseCsvRow(lines[0]).map(h => h.toLowerCase());
        const products = [];

        for (let i = 1; i < lines.length; i++) {
          if (!lines[i]) continue;
          const values = parseCsvRow(lines[i]);
          const product = {};

          headers.forEach((header, index) => {
            let value = values[index] || '';
            switch (header) {
              case 'price':
                product.price = parseFloat(value) || 0;
                break;
              case 'in_stock':
                // Check for various true/false representations
                product.in_stock = ['true', 'yes', '1'].includes(value.toLowerCase());
                break;
              default:
                product[header] = value;
            }
          });
          products.push(product);
        }
        return products;
      }

      // --- Fetch Products ---
      async function fetchProducts() {
        try {
          const response = await fetch(googleSheetCsvUrl);
          if (!response.ok) throw new Error('Sheet not reachable, status ' + response.status);
          const csvText = await response.text();
          allProducts = parseCSV(csvText); // Store fetched products globally
          return allProducts;
        } catch (err) {
          errorDisplay.style.display = 'block';
          errorDisplay.textContent = 'Failed to load data: ' + err.message;
          return [];
        }
      }

      // --- Cart Management Functions ---
      function updateCartCount() {
        const totalItems = Object.values(cart).reduce((sum, item) => sum + item.quantity, 0);
        cartCountSpan.textContent = totalItems;
        localStorage.setItem('kegalleScoutCart', JSON.stringify(cart));
      }

      function addToCart(productId) {
        const product = allProducts.find(p => p.product_id === productId);
        if (!product) return;

        if (cart[productId]) {
          cart[productId].quantity++;
        } else {
          cart[productId] = { ...product, quantity: 1 };
        }
        updateCartCount();
        renderCartItems();
      }

      function removeFromCart(productId) {
        delete cart[productId];
        updateCartCount();
        renderCartItems();
      }

      function updateCartItemQuantity(productId, change) {
        if (cart[productId]) {
          cart[productId].quantity += change;
          if (cart[productId].quantity <= 0) {
            removeFromCart(productId);
          }
        }
        updateCartCount();
        renderCartItems();
      }

      function calculateCartTotal() {
        let total = 0;
        for (const productId in cart) {
          total += cart[productId].price * cart[productId].quantity;
        }
        return total;
      }

      // --- Render Functions ---
      function renderProducts(products) {
        productGrid.innerHTML = '';
        if (products.length === 0) {
          productGrid.innerHTML = '<p>No products available.</p>';
          return;
        }

        products.forEach(product => {
          const card = document.createElement('div');
          card.className = 'product-card';
          card.innerHTML = `
            <img src="${product.image || 'https://placehold.co/300x200?text=No+Image'}" alt="${product.product_name || 'Product Image'}" onerror="this.src='https://placehold.co/300x200?text=No+Image';">
            <div class="product-info">
              <h3>${product.product_name || 'No Name'}</h3>
              <p><strong>ID:</strong> ${product.product_id || '-'}</p>
              <p><strong>Category:</strong> ${product.category || '-'}</p>
              <p><strong>Price:</strong> Rs. ${product.price ? product.price.toFixed(2) : '0.00'}</p>
              <p class="product-status ${product.in_stock ? 'status-in-stock' : 'status-out-of-stock'}">
                <strong>Status:</strong> ${product.in_stock ? 'In Stock' : 'Out of Stock'}
              </p>
              <p>${product.discription || ''}</p>
            </div>
            <div class="product-actions">
              ${product.in_stock
                ? `<button class="add-to-cart-btn" data-product-id="${product.product_id}">Add to Cart</button>`
                : `<button class="pre-order-btn" data-product-id="${product.product_id}">Pre-Order</button>`
              }
            </div>
          `;
          productGrid.appendChild(card);
        });

        // Add event listeners after rendering
        productGrid.querySelectorAll('.add-to-cart-btn').forEach(button => {
          button.addEventListener('click', (e) => {
            addToCart(e.target.dataset.productId);
            // Optionally, show a confirmation or open the cart modal
          });
        });

        productGrid.querySelectorAll('.pre-order-btn').forEach(button => {
          button.addEventListener('click', (e) => {
            handlePreOrder(e.target.dataset.productId);
          });
        });
      }

      function renderCartItems() {
        cartItemsContainer.innerHTML = '';
        if (Object.keys(cart).length === 0) {
          cartItemsContainer.innerHTML = '<p>Your cart is empty.</p>';
          orderWhatsappBtn.style.display = 'none'; // Hide WhatsApp button if cart is empty
        } else {
          orderWhatsappBtn.style.display = 'flex'; // Show WhatsApp button if cart has items
          for (const productId in cart) {
            const item = cart[productId];
            const itemDiv = document.createElement('div');
            itemDiv.className = 'cart-item';
            itemDiv.innerHTML = `
              <div class="cart-item-info">
                <h4>${item.product_name}</h4>
                <p>Rs. ${item.price.toFixed(2)} x ${item.quantity}</p>
              </div>
              <div class="item-quantity-controls">
                <button data-product-id="${item.product_id}" data-action="decrease">-</button>
                <span>${item.quantity}</span>
                <button data-product-id="${item.product_id}" data-action="increase">+</button>
                <button class="remove-from-cart-btn" data-product-id="${item.product_id}">Remove</button>
              </div>
            `;
            cartItemsContainer.appendChild(itemDiv);
          }
        }
        cartTotalSpan.textContent = `Total: Rs. ${calculateCartTotal().toFixed(2)}`;

        // Add event listeners for quantity controls and remove buttons
        cartItemsContainer.querySelectorAll('.item-quantity-controls button').forEach(button => {
          button.addEventListener('click', (e) => {
            const productId = e.target.dataset.productId;
            const action = e.target.dataset.action;
            if (action === 'increase') {
              updateCartItemQuantity(productId, 1);
            } else if (action === 'decrease') {
              updateCartItemQuantity(productId, -1);
            }
          });
        });

        cartItemsContainer.querySelectorAll('.remove-from-cart-btn').forEach(button => {
          button.addEventListener('click', (e) => {
            removeFromCart(e.target.dataset.productId);
          });
        });
      }

      // --- WhatsApp Order Function ---
      function generateWhatsAppMessage() {
        let message = `Hello, I'd like to place an order from Kegalle Scout Shop Online Store.\n\nMy order details:\n`;
        let total = 0;

        for (const productId in cart) {
          const item = cart[productId];
          message += `- ${item.product_name} (ID: ${item.product_id}) x ${item.quantity} - Rs. ${item.price.toFixed(2)} each\n`;
          total += item.price * item.quantity;
        }

        message += `\nTotal amount: Rs. ${total.toFixed(2)}\n\n`;
        message += `Please confirm availability and guide me on the payment process.\nThank you!`;
        return encodeURIComponent(message);
      }

      function handlePreOrder(productId) {
        const product = allProducts.find(p => p.product_id === productId);
        if (!product) return;

        const preOrderMessage = encodeURIComponent(
          `Hello, I would like to pre-order the following item from Kegalle Scout Shop:\n\n` +
          `- Product Name: ${product.product_name}\n` +
          `- Product ID: ${product.product_id}\n` +
          `- Category: ${product.category}\n` +
          `\nPlease let me know when this item is back in stock and how I can proceed with the pre-order.`
        );
        window.open(`https://wa.me/${whatsappNumber}?text=${preOrderMessage}`, '_blank');
      }

      // --- Event Listeners ---
      cartSummary.addEventListener('click', () => {
        cartModal.style.display = 'flex';
        renderCartItems();
      });

      closeButton.addEventListener('click', () => {
        cartModal.style.display = 'none';
      });

      window.addEventListener('click', (event) => {
        if (event.target == cartModal) {
          cartModal.style.display = 'none';
        }
      });

      orderWhatsappBtn.addEventListener('click', () => {
        const whatsappMessage = generateWhatsAppMessage();
        window.open(`https://wa.me/${whatsappNumber}?text=${whatsappMessage}`, '_blank');
        // Optionally, clear cart after ordering or show a confirmation
        // cart = {};
        // updateCartCount();
        // renderCartItems();
      });

      // --- Initial Load ---
      fetchProducts().then(products => {
        loadingIndicator.style.display = 'none';
        renderProducts(products);
        updateCartCount(); // Initialize cart count on page load
      });
    });
  </script>
</body>
</html>
