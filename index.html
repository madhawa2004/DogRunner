<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kegalle Scout Shop - Premium Scouting Equipment</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-red: #dc2626;
            --secondary-red: #b91c1c;
            --accent-yellow: #fbbf24;
            --whatsapp-green: #25D366;
            --whatsapp-hover: #1DA851;
            --white: #ffffff;
            --light-gray: #f8fafc;
            --medium-gray: #64748b;
            --dark-gray: #334155;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--secondary-red) 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="scout" patternUnits="userSpaceOnUse" width="20" height="20"><circle cx="10" cy="10" r="2" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23scout)"/></svg>');
            opacity: 0.1;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 1;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-placeholder {
            width: 8px;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 2rem;
            transition: all 0.3s ease;
        }

        .logo-placeholder:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.3);
        }

        .brand-info h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .brand-info p {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .header-stats {
            text-align: center;
            opacity: 0.9;
        }

        .header-stats .stat-number {
            font-size: 2rem;
            font-weight: 700;
            display: block;
            color: var(--accent-yellow);
        }

        /* Loading Animation */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2rem;
            color: var(--medium-gray);
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        /* Search and Filter */
        .controls {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 3rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-red);
            background: white;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--medium-gray);
        }

        .sort-select {
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: #f8fafc;
            font-size: 1rem;
            min-width: 150px;
            transition: all 0.3s ease;
        }

        .sort-select:focus {
            outline: none;
            border-color: var(--primary-red);
            background: white;
        }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        /* Product Card */
        .product-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border: 1px solid #e2e8f0;
        }

        .product-card:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow-hover);
            border-color: var(--primary-red);
        }

        .product-image-container {
            position: relative;
            height: 250px;
            overflow: hidden;
            background: linear-gradient(45deg, #f8fafc, #e2e8f0);
        }

        .product-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s ease;
        }

        .product-card:hover img {
            transform: scale(1.1);
        }

        .product-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--accent-yellow);
            color: var(--dark-gray);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .product-info {
            padding: 2rem;
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .product-id {
            background: var(--primary-red);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .product-name {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }

        .product-description {
            color: var(--medium-gray);
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .product-price {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-red);
            margin-bottom: 1.5rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .whatsapp-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, var(--whatsapp-green) 0%, var(--whatsapp-hover) 100%);
            color: white;
            padding: 1rem 1.5rem;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
            width: 100%;
        }

        .whatsapp-button:hover {
            background: linear-gradient(135deg, var(--whatsapp-hover) 0%, #16a34a 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 211, 102, 0.4);
        }

        .whatsapp-button i {
            font-size: 1.2rem;
        }

        /* Error Message */
        .error-message {
            text-align: center;
            background: #fee2e2;
            color: #dc2626;
            padding: 2rem;
            border-radius: 15px;
            margin: 2rem 0;
            border: 1px solid #fecaca;
        }

        .no-products {
            text-align: center;
            color: var(--medium-gray);
            font-size: 1.2rem;
            padding: 4rem 2rem;
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .no-products i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 1.5rem;
            }

            .brand-info h1 {
                font-size: 2rem;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                min-width: auto;
            }

            .product-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .container {
                padding: 2rem 1rem;
            }
        }

        /* Fade-in Animation */
        .fade-in {
            opacity: 0;
            transform: translateY(30px);
            animation: fadeInUp 0.6s ease forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Stagger animation for cards */
        .product-card:nth-child(1) { animation-delay: 0.1s; }
        .product-card:nth-child(2) { animation-delay: 0.2s; }
        .product-card:nth-child(3) { animation-delay: 0.3s; }
        .product-card:nth-child(4) { animation-delay: 0.4s; }
        .product-card:nth-child(5) { animation-delay: 0.5s; }
        .product-card:nth-child(6) { animation-delay: 0.6s; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-placeholder">
                    <img src="logo.png"  class="logo-image">
                </div>
                <div class="brand-info">
                    <h1>Kegalle Scout Shop</h1>
                    <p>Premium Scouting Equipment & Gear</p>
                </div>
            </div>
            <div class="header-stats">
                <span class="stat-number" id="product-count">0</span>
                <span>Products Available</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="controls">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="Search products..." />
            </div>
            <select class="sort-select" id="sort-select">
                <option value="name">Sort by Name</option>
                <option value="price-low">Price: Low to High</option>
                <option value="price-high">Price: High to Low</option>
                <option value="id">Sort by ID</option>
            </select>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            Loading products...
        </div>

        <div id="product-grid" class="product-grid"></div>
        
        <div class="error-message" id="error-display" style="display: none;"></div>
    </div>

    <script>
        // Configuration
        const googleSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQws-dLb68ZTjwNhkZU5vYBtsdM80KAqr0BkWQyq56yJsSM6ze540fseOcYSgWuPimLfJ6fX2J0GGFs/pub?gid=1261177907&single=true&output=csv';
        const whatsappNumber = '94713892108';

        let allProducts = [];
        let filteredProducts = [];

        // DOM Elements
        const loadingEl = document.getElementById('loading');
        const productGridEl = document.getElementById('product-grid');
        const errorDisplayEl = document.getElementById('error-display');
        const searchInput = document.getElementById('search-input');
        const sortSelect = document.getElementById('sort-select');
        const productCountEl = document.getElementById('product-count');

        // Utility Functions
        function showError(message) {
            errorDisplayEl.textContent = message;
            errorDisplayEl.style.display = 'block';
            loadingEl.style.display = 'none';
        }

        function hideError() {
            errorDisplayEl.style.display = 'none';
        }

        function showLoading() {
            loadingEl.style.display = 'flex';
            productGridEl.innerHTML = '';
            hideError();
        }

        function hideLoading() {
            loadingEl.style.display = 'none';
        }

        function updateProductCount(count) {
            productCountEl.textContent = count;
            productCountEl.style.animation = 'none';
            setTimeout(() => {
                productCountEl.style.animation = 'fadeInUp 0.5s ease';
            }, 10);
        }

        // Parse CSV data with better handling
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            if (lines.length < 2) {
                throw new Error('Insufficient data in spreadsheet');
            }

            // Better CSV parsing to handle commas in URLs
            function parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            }

            const headers = parseCSVLine(lines[0]).map(h => h.replace(/"/g, '').toLowerCase());
            const products = [];

            console.log('CSV Headers found:', headers); // Debug log

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]).map(v => v.replace(/"/g, ''));
                if (values.length > 0 && values[0]) { // Check if row has data
                    const product = {};
                    headers.forEach((header, index) => {
                        product[header] = values[index] || '';
                    });
                    
                    console.log('Parsed product:', product); // Debug log
                    
                    // Only add products with required fields
                    if (product.product_name && product.price) {
                        products.push(product);
                    }
                }
            }

            return products;
        }

        // Function to convert Google Drive links to direct image URLs
        function convertGoogleDriveUrl(url) {
            if (!url || !url.includes('drive.google.com')) {
                return url;
            }
            
            // Extract file ID from different Google Drive URL formats
            let fileId = '';
            
            // Format 1: https://drive.google.com/file/d/FILE_ID/view
            const viewMatch = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (viewMatch) {
                fileId = viewMatch[1];
            }
            
            // Format 2: https://drive.google.com/open?id=FILE_ID
            const openMatch = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
            if (openMatch) {
                fileId = openMatch[1];
            }
            
            if (fileId) {
                // Convert to direct download URL
                const directUrl = `https://drive.google.com/uc?export=view&id=${fileId}`;
                console.log(`üîÑ Converted Google Drive URL: ${url} ‚Üí ${directUrl}`);
                return directUrl;
            }
            
            console.warn('‚ö†Ô∏è Could not extract file ID from Google Drive URL:', url);
            return url;
        }

        // Create product card HTML with Google Drive link conversion
        function createProductCard(product) {
            const productName = product.product_name || 'Unknown Product';
            const productId = product.product_id || product.id || 'N/A';
            const price = product.price ? parseFloat(product.price).toFixed(2) : '0.00';
            const description = product.description || 'No description available';
            
            // Debug: Show all product properties
            console.log('=== PRODUCT DEBUG ===');
            console.log('Product Name:', productName);
            console.log('All Product Properties:', Object.keys(product));
            
            // Try multiple possible image column names (case-insensitive)
            let imageUrl = '';
            const possibleImageColumns = [
                'imageurl', 'image_url', 'image', 'img', 'picture', 'photo',
                'ImageURL', 'Image_URL', 'Image', 'IMG', 'Picture', 'Photo',
                'image link', 'Image Link', 'imageLink', 'ImageLink'
            ];
            
            for (const col of possibleImageColumns) {
                // Check both exact match and lowercase match
                if (product[col] && product[col].trim()) {
                    imageUrl = product[col].trim();
                    console.log(`Found image in column "${col}":`, imageUrl);
                    break;
                }
                // Also check case-insensitive
                const lowerCol = col.toLowerCase();
                const foundKey = Object.keys(product).find(key => key.toLowerCase() === lowerCol);
                if (foundKey && product[foundKey] && product[foundKey].trim()) {
                    imageUrl = product[foundKey].trim();
                    console.log(`Found image in column "${foundKey}" (matched "${col}"):`, imageUrl);
                    break;
                }
            }
            
            // Convert Google Drive URLs to direct image URLs
            if (imageUrl) {
                imageUrl = convertGoogleDriveUrl(imageUrl);
            }
            
            console.log('Final Image URL:', imageUrl);
            console.log('===================');
            
            // If no image found or invalid URL, use placeholder
            if (!imageUrl || (!imageUrl.startsWith('http://') && !imageUrl.startsWith('https://'))) {
                console.log('Using placeholder image for:', productName);
                imageUrl = 'https://via.placeholder.com/400x250/dc2626/ffffff?text=' + encodeURIComponent(productName);
            }

            const whatsappMessage = encodeURIComponent(
                `üõçÔ∏è *Order from Kegalle Scout Shop*\n\n` +
                `Product: ${productName}\n` +
                `ID: ${productId}\n` +
                `Price: Rs. ${price}\n\n` +
                `I would like to order this item. Please provide more details.`
            );
            
            const whatsappLink = `https://wa.me/${whatsappNumber}?text=${whatsappMessage}`;

            return `
                <div class="product-card fade-in">
                    <div class="product-image-container">
                        <img src="${imageUrl}" alt="${productName}" 
                             onerror="console.error('‚ùå Image failed to load:', this.src); this.src='https://via.placeholder.com/400x250/dc2626/ffffff?text=${encodeURIComponent('Image Error')}';"
                             onload="console.log('‚úÖ Image loaded successfully:', this.src)"
                             loading="lazy">
                        <div class="product-badge">Scout Gear</div>
                    </div>
                    <div class="product-info">
                        <div class="product-header">
                            <div class="product-id">ID: ${productId}</div>
                        </div>
                        <h3 class="product-name">${productName}</h3>
                        <p class="product-description">${description}</p>
                        <div class="product-price">Rs. ${price}</div>
                        <a href="${whatsappLink}" class="whatsapp-button" target="_blank">
                            <i class="fab fa-whatsapp"></i>
                            Order via WhatsApp
                        </a>
                    </div>
                </div>
            `;
        }

        // Display products
        function displayProducts(products) {
            if (products.length === 0) {
                productGridEl.innerHTML = `
                    <div class="no-products">
                        <i class="fas fa-search"></i>
                        <h3>No products found</h3>
                        <p>Try adjusting your search or filters</p>
                    </div>
                `;
                return;
            }

            productGridEl.innerHTML = products.map(createProductCard).join('');
            updateProductCount(products.length);
        }

        // Sort products
        function sortProducts(products, sortBy) {
            const sorted = [...products];
            
            switch (sortBy) {
                case 'name':
                    return sorted.sort((a, b) => a.product_name.localeCompare(b.product_name));
                case 'price-low':
                    return sorted.sort((a, b) => parseFloat(a.price || 0) - parseFloat(b.price || 0));
                case 'price-high':
                    return sorted.sort((a, b) => parseFloat(b.price || 0) - parseFloat(a.price || 0));
                case 'id':
                    return sorted.sort((a, b) => (a.product_id || a.id || '').localeCompare(b.product_id || b.id || ''));
                default:
                    return products;
            }
        }

        // Filter products
        function filterProducts() {
            const searchTerm = searchInput.value.toLowerCase();
            const sortBy = sortSelect.value;

            let filtered = allProducts;

            if (searchTerm) {
                filtered = allProducts.filter(product => 
                    (product.product_name || '').toLowerCase().includes(searchTerm) ||
                    (product.description || '').toLowerCase().includes(searchTerm) ||
                    (product.product_id || product.id || '').toLowerCase().includes(searchTerm)
                );
            }

            filtered = sortProducts(filtered, sortBy);
            filteredProducts = filtered;
            displayProducts(filtered);
        }

        // Fetch products from Google Sheets
        async function fetchProducts() {
            showLoading();
            
            try {
                const response = await fetch(googleSheetUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }

                const csvData = await response.text();
                
                // Debug: Show raw CSV data
                console.log('Raw CSV Data (first 500 chars):', csvData.substring(0, 500));
                
                allProducts = parseCSV(csvData);
                
                // Debug: Show parsed products
                console.log('Parsed Products:', allProducts);
                
                if (allProducts.length === 0) {
                    throw new Error('No valid products found in the spreadsheet');
                }

                filteredProducts = [...allProducts];
                hideLoading();
                filterProducts();

            } catch (error) {
                console.error('Error fetching products:', error);
                showError(`Failed to load products: ${error.message}. Please try again later.`);
            }
        }

        // Event Listeners
        searchInput.addEventListener('input', debounce(filterProducts, 300));
        sortSelect.addEventListener('change', filterProducts);

        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchProducts();
        });

        // Add some interactive effects
        document.addEventListener('click', (e) => {
            if (e.target.closest('.whatsapp-button')) {
                const button = e.target.closest('.whatsapp-button');
                button.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    button.style.transform = '';
                }, 150);
            }
        });
    </script>
</body>
</html>
